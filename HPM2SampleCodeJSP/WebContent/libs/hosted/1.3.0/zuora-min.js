/*    Copyright (c) 2014 Zuora, Inc.
 *
 *   Permission is hereby granted, free of charge, to any person obtaining a copy of 
 *   this software and associated documentation files (the "Software"), to use copy, 
 *   modify, merge, publish the Software and to distribute, and sublicense copies of 
 *   the Software, provided no fee is charged for the Software.  In addition the
 *   rights specified above are conditioned upon the following:
 *
 *   The above copyright notice and this permission notice shall be included in all
 *   copies or substantial portions of the Software.
 *
 *   Zuora, Inc. or any other trademarks of Zuora, Inc.  may not be used to endorse
 *   or promote products derived from this Software without specific prior written
 *   permission from Zuora, Inc.
 *
 *   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 *   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 *   FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL
 *   ZUORA, INC. BE LIABLE FOR ANY DIRECT, INDIRECT OR CONSEQUENTIAL DAMAGES
 *   (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 *   LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 *   ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 *   SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
var __z_version="1.3.0";var ifrmId="z_hppm_iframe";var threedRedirected=false;if(!String.prototype.trim){(function(){var a=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;String.prototype.trim=function(){return this.replace(a,"")}})()}if(!Object.keys){Object.keys=(function(){var c=Object.prototype.hasOwnProperty,d=!({toString:null}).propertyIsEnumerable("toString"),b=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],a=b.length;return function(g){if(typeof g!=="object"&&(typeof g!=="function"||g===null)){throw new TypeError("Object.keys called on non-object")}var e=[],h,f;for(h in g){if(c.call(g,h)){e.push(h)}}if(d){for(f=0;f<a;f++){if(c.call(g,b[f])){e.push(b[f])}}}return e}}())}(function(){if(!Event.prototype.preventDefault){Event.prototype.preventDefault=function(){this.returnValue=false}}if(!Event.prototype.stopPropagation){Event.prototype.stopPropagation=function(){this.cancelBubble=true}}if(!Element.prototype.addEventListener){var c=[];var b=function(f,h){var d=this;var j=function(k){k.target=k.srcElement;k.currentTarget=d;if(h.handleEvent){h.handleEvent(k)}else{h.call(d,k)}};if(f=="DOMContentLoaded"){var g=function(k){if(document.readyState=="complete"){j(k)}};document.attachEvent("onreadystatechange",g);c.push({object:this,type:f,listener:h,wrapper:g});if(document.readyState=="complete"){var i=new Event();i.srcElement=window;g(i)}}else{if(this.attachEvent){this.attachEvent("on"+f,j)}c.push({object:this,type:f,listener:h,wrapper:j})}};var a=function(f,g){var d=0;while(d<c.length){var e=c[d];if(e.object==this&&e.type==f&&e.listener==g){if(f=="DOMContentLoaded"){this.detachEvent("onreadystatechange",e.wrapper)}else{this.detachEvent("on"+f,e.wrapper)}c.splice(d,1);break}++d}};Element.prototype.addEventListener=b;Element.prototype.removeEventListener=a;if(HTMLDocument){HTMLDocument.prototype.addEventListener=b;HTMLDocument.prototype.removeEventListener=a}if(Window&&Window.prototype){Window.prototype.addEventListener=b;Window.prototype.removeEventListener=a}}})();var ZLOG=(function(){var d="zlog_level";
var h="error";var e="warn";var b="info";var a="debug";var c=e;var j=[h,e,b,a];function i(m){var l;for(l=0;l<j.length;l++){if(j[l]===m){return l}}return -1}function g(){var l=document.location.href;var m=l.indexOf("?");if(m<0){return c}var q=l.indexOf("#");if(q<0){q=l.length}var r=l.slice(m+1,q);if(!r){return c}var u=r.split("&");var o;for(o=0;o<u.length;o++){var n=u[o].split("=");var t=n[0];var s=n[1];if(t===d&&i(s)>=0){return s}}return e}function k(){return i(g())>=i(a)}function f(){return i(g())>=i(b)}return{getLevel:function(){return g()},debug:function(l){if(console&&console.log&&k()){console.log(l)}},info:function(l){if(console&&console.info&&f()){console.info(l)}},warn:function(l){if(console&&console.warn){console.warn(l)}},error:function(l){if(console&&console.error){console.error(l)}}}})();var ZXD=function(){var e,d,b=1,c,a=this;return{postMessage:function(f,h,g){ZLOG.debug("Posting message[O]: target_url="+h+", payload="+f);if(!h){return}g=g||parent;if(a.postMessage){g.postMessage(f,h.replace(/([^:]+:\/\/[^\/]+).*/,"$1"))}else{if(h){g.location=h.replace(/#.*$/,"")+"#"+(+new Date)+(b++)+"&"+f}}},receiveMessage:function(h,g,f){ZLOG.info("Registering callback[O]: source_origin="+g+", allowSubDomain="+f);if(a.postMessage){if(h){c=function(m){function j(s){var t=/^https:\/\/([a-z0-9]+(-[a-z0-9]+)*\.)*zuora\.com$/;if(!t.test(s.toLowerCase())){return false}return true}var l=/^https?:\/\/localhost(:\d{4,5})?$/;function q(s){return l.test(s)}ZLOG.debug("Received message[O]: origin="+m.origin);if(typeof m.origin==="string"&&!(j(m.origin)||q(m.origin))){ZLOG.info("Stopped processing none-zuora message.");return !1}if(Object.prototype.toString.call(g)==="[object Function]"&&g(m.origin)===!1){return !1}if(typeof g==="string"&&m.origin!==g){if(!f){return !1}else{if(f==="true"){try{if(typeof g==="string"){var r=m.origin.split(".");if(r){var i=r.slice(-2).join(".");var k=g.split(".");var o=k.slice(-2).join(".");if(o.indexOf(i)<=-1){return !1}}}}catch(n){return !1}}else{return !1}}}h(m)}}if(a.addEventListener){a[h?"addEventListener":"removeEventListener"]("message",c,!1)
}else{a[h?"attachEvent":"detachEvent"]("onmessage",c)}}else{e&&clearInterval(e);e=null;if(h){e=setInterval(function(){var j=document.location.hash,i=/^#?\d+&/;if(j!==d&&i.test(j)){d=j;h({data:j.replace(i,"")})}},100)}}}}}();var Z=function(){var h="#z-overlay {filter: alpha(opacity=50);opacity:0.5;display:inline-block;position:fixed;top:0;left:0;width:100%;height:100%;background-color: #000;z-index: 1001;}";var r="#z-container {border:1px;float:left; overflow: visible; position: absolute;padding: 0px; display: inline-block; top:5%; left:34%; margin: 0 auto;-webkit-border-radius: 5px;-moz-border-radius: 5px;border-radius:5px;background-color: #FAFAFA; border:1px solid #FAFAFA;border-top-color:#EDEDED;behavior: url(js/PIE.htc);z-index: 1002;}";var g="#z-data {height: 100%; outline: 0px; width: 100%; overflow: visible;display: inline-block;border:1px; -webkit-border-radius: 5px;-moz-border-radius: 5px;border-radius:5px;}";var q="#reset{*, *:before, *:after {display: inline-block;-webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box;}}";var j="#z_hppm_iframe {background-color: #FAFAFA;vertical-align:bottom;z-index:9999;display:block;padding:0px;margin: 0px; border:0px solid #DDD;}";var e="requestPage";var d;var o;var b,l,c;var t=["tenantId","id","token","signature","key","style","submitEnabled","url"];var i=["creditCardNumber","cardSecurityCode","creditCardExpirationYear","creditCardExpirationMonth","bankAccountNumber","bankAccountName","ipAddress"];var n=false;var k={};var f=null;var s=null;function a(u){return u&&typeof u==="function"}function m(u){var v={};for(var w in u){if(u.hasOwnProperty(w)){v[w]=u[w]}}return v}ZXD.receiveMessage(function(v){try{var u=v.data;ZLOG.debug("Received message[O]: payload="+u);u=JSON.parse(u);if(u.success){if(a(k.init)){k.init(u)}}else{if(u.success==false){Z.deactivateOverlay("z-overlay");Z.deactivateOverlay("z-container");if(k.init){k.init(u)}}else{if(u.action=="close"){Z.deactivateOverlay("z-overlay");Z.deactivateOverlay("z-container")}else{if(u.action=="resize"){Z.receive(u)
}else{if(u.action=="allowScroll"){Z.allowScroll(u)}}}}}if(u.action==="validate"&&a(k.validate)){k.validate(u)}else{if(u.action=="customizeErrorMessage"&&a(k.customizeErrorMessage)){k.customizeErrorMessage(u.key,u.code,u.message)}else{if(u.action&&a(k[u.action])){k[u.action](u)}}}}catch(w){return}});return{validateRequiredParams:function(w){var u=t.length;for(index=0;index<u;index++){if(!w.hasOwnProperty(t[index])){if(t[index]=="submitEnabled"&&w.style.toLowerCase()=="overlay"){continue}else{var v="Param with key ["+t[index]+"] is required.";alert(v);if(!Z.isIE()){console.log(v)}return false}}}return true},isIE:function(){var w=window.navigator.userAgent;var v=w.indexOf("MSIE ");var u=w.indexOf("Trident/");if(v>0){return true}if(u>0){var x=w.indexOf("rv:");return true}return false},validatePCIParams:function(x){var u=i.length;for(index=0;index<u;index++){var v="field_"+i[index];if(x.hasOwnProperty(v)){if(0<x[v].trim().length&&x[v].trim().length<300){var w="Field ["+v+"] for Credit Card payment method type should be encrypted for pre-population";alert(w);if(!Z.isIE()){console.log(w)}return false}}}return true},init:function(z,A){b="?method=requestPage&host="+encodeURIComponent(document.location.href)+"&";b=b+"fromHostedPage=true&";var y=Z.validateRequiredParams(z);if(!y){return false}y=Z.validatePCIParams(z);if(!y){return false}var x=JSON.stringify(z,function(C,D){if(C!=""){if("key"==C){c=D}else{if("url"==C){var B=/^https:\/\/([a-z0-9]+(-[a-z0-9]+)*\.)+zuora\.com\/.+$/;ZLOG.info("HPM integration[O]: url="+D);if(!B.test(D)){ZLOG.warn("HPM integration[O]: None-official zuora HPM integration url is detected: "+D)}d=D}else{b=b+C+"="+encodeURIComponent(D)+"&"}}}return D});p=JSON.parse(x);k.init=A;var u=i.length;if(z){for(var w=0;w<u;w++){var v="field_"+i[w];if(z.hasOwnProperty(v)){z[v]=""}}}return true},prepopulate:function(w){if(threedRedirected){return}var x=Z.createIframeURL();if(x==document.getElementById(ifrmId).src||(document.getElementById(ifrmId).src.indexOf(x)>=0&&p.hasOwnProperty("customizeErrorRequired")&&p.customizeErrorRequired=="true")){var u=JSON.stringify(w,function(y,A){if(y!=""){var z="setField("+y+":"+A+")";
Z.post(ifrmId,z)}return A});var v="setField(key:"+c+")";Z.post(ifrmId,v);Z.post(ifrmId,"setField(style:"+p.style+")");if(p.hasOwnProperty("customizeErrorRequired")&&p.customizeErrorRequired=="true"){Z.post(ifrmId,"customizeErrorRequired");p.customizeErrorRequired="false"}Z.post(ifrmId,"resize");if(o){o()}}if(o){o=null}},contains:function(u,w){for(var v=0;v<u.length;v++){if(u[v]===w){return true}}return false},renderWithErrorHandler:function(x,z,y,v,w,u){x.customizeErrorRequired="true";Z.render(x,z,y,w,u);Z.customizeErrorHandler(v)},runAfterRender:function(u){o=u},render:function(z,y,E,x,F){if(x!=null&&x!=undefined){f=x}if(F!=null&&F!=undefined){s=F}var C=i.length;threedRedirected=false;if(y&&y.creditCardCountry&&(y.creditCardCountry==="USA"||y.creditCardCountry==="CAN")){y.creditCardState=y.creditCardState||" "}if(y){for(index=0;index<C;index++){var A="field_"+i[index];if(y.hasOwnProperty(i[index])){z[A]=y[i[index]]}}}var G=Z.init(z,E);if(!G){return}if(y){var C=Object.keys(y).length;l=m(y);for(index=0;index<C;index++){var w=Object.keys(y)[index];if(Z.contains(i,w)){delete l[w]}}}else{l=null}var v=document.getElementById("zuora_payment");if(typeof v=="undefined"||!v){return{error:"invalid_request",error_description:"The container you specified does not exist"}}v.innerHTML="";Z.cleanUp(v,"z-overlay");Z.cleanUp(v,"z-container");if(p.style=="inline"){Z.addInlineStyles();Z.createIframe(v);return}if(p.style=="overlay"){Z.addOverlayStyles();var u=Z.generateDiv("z-overlay","z-overlay");v.appendChild(u);var B=Z.generateDiv("z-container","z-container");v.appendChild(B);var D=Z.generateDiv("z-data","z-data");D.tabindex="-1";B.appendChild(D);Z.createIframe(document.getElementById("z-data"));Z.activateOverlay("z-overlay")}},cleanUp:function(v,u){var w=document.getElementById(u);if(w!=null){v.removeChild(w)}},activateOverlay:function(v){try{document.getElementById(v).style.display="inline"}catch(u){}},deactivateOverlay:function(v){try{document.getElementById(v).style.display="none"}catch(u){}},generateDiv:function(x,v,u){var w=document.createElement("div");
w.id=x;w.className=v;w.border="0";if(w.addEventListener){w.addEventListener("click",u,false)}else{w.attachEvent("click",u)}return w},addOverlayStyles:function(){var y=document.createElement("style");y.type="text/css";var v=document.createTextNode(h);var z=document.createTextNode(r);var u=document.createTextNode(g);var x=document.createTextNode(j);var w=document.createTextNode(q);if(y.styleSheet){y.styleSheet.cssText=v.nodeValue+" "+z.nodeValue+" "+u.nodeValue+" "+w.nodeValue+" "+x.nodeValue}else{y.appendChild(v);y.appendChild(z);y.appendChild(u);y.appendChild(x);y.appendChild(w)}document.getElementsByTagName("head")[0].appendChild(y)},addInlineStyles:function(){var v=document.createElement("style");v.type="text/css";var u=document.createTextNode(j);if(v.styleSheet){v.styleSheet.cssText=u.nodeValue}else{v.appendChild(u)}document.getElementsByTagName("head")[0].appendChild(v)},createIframe:function(u){var w=Z.createIframeURL();var v=document.createElement("iframe");v.setAttribute("src",w);v.setAttribute("id",ifrmId);v.setAttribute("overflow","visible");v.setAttribute("scrolling","no");v.setAttribute("frameBorder","0");v.setAttribute("allowtransparency","true");v.setAttribute("class","z_hppm_iframe");v.setAttribute("width","100%");v.setAttribute("height","100%");if(v.addEventListener){v.addEventListener("load",function(x){Z.prepopulate(l);return false},false)}else{v.attachEvent("onload",function(){Z.prepopulate(l);return false})}if(typeof options!="undefined"){if(typeof options.vertical!="undefined"&&options.vertical){v.style.width="100%";v.style.height="100%"}}u.appendChild(v)},createIframeURL:function(){var u=d;return u.concat(b).concat("zlog_level="+ZLOG.getLevel())},post:function(x,w){var u=document.getElementById(x);var v=encodeURIComponent(document.location.href);var y=u.src;if(y.indexOf(v)<=-1){u.src=y+"#"+v}ZXD.postMessage(w,y,u.contentWindow);return false},allowScroll:function(v){if(ifrmId){var u=document.getElementById(ifrmId);if(u){u.setAttribute("scrolling","yes");threedRedirected=true}}},receive:function(u){ZFB.resizeCaller(ifrmId,u.action,u.height,u.width,f,s)
},validate:function(w){if(w==null||w==undefined){Z.closeWindow();var v="Validate function required.";alert(v);if(!Z.isIE()){console.log(v)}return false}k.validate=w;var u="validate";Z.post(ifrmId,u)},customizeErrorHandler:function(v){if(v==null||v==undefined){Z.closeWindow();var u="Customized error message function required.";alert(u);if(!Z.isIE()){console.log(u)}return false}k.customizeErrorMessage=v},sendErrorMessageToHpm:function(x,w){var v={action:"customizeErrorMessage",key:x,message:w};var u=JSON.stringify(v);Z.post(ifrmId,u)},closeWindow:function(){Z.deactivateOverlay("z-overlay");Z.deactivateOverlay("z-container")},submit:function(){var u=document.getElementById(ifrmId).src+"#"+encodeURIComponent(document.location.href);document.getElementById(ifrmId).src=u;ZXD.postMessage("postPage",u,document.getElementById(ifrmId).contentWindow);return true},responseHandler:function(u){var v=u.redirectUrl;if(u.success){var w=v+"?refId="+u.refId+"&success="+u.success+"&signature="+u.signature+"&token="+u.token;window.location.replace(w)}else{var w=v+"?errorCode="+u.errorCode+"&errorMessage="+u.errorMessage+"&success="+u.success+"&signature="+u.signature+"&token="+u.token;window.location.replace(w)}},setEventHandler:function(u,v){if(u&&v){k[u]=v}}}}();var ZFB=function(){var b="yes";var c=navigator.userAgent.substring(navigator.userAgent.indexOf("Firefox")).split("/")[1];var a=parseFloat(c)>=0.1?20:0;return{resizeCaller:function(j,i,d,h,g,e){ZFB.resizeIframe(j,i,d,h,g,e);if((document.all||document.getElementById)&&b=="no"){var f=document.all?document.all[j]:document.getElementById(j);f.style.display="block"}},resizeIframe:function(h,k,f,j,i,g){var d=document.getElementById(h);if(d){d.style.display="block";if(i!=null&&i!=undefined){try{if(!isNaN(i)&&i.length>0){d.width=Number(i)}else{d.width=Number(j)}}catch(l){d.width=Number(j)}}else{d.width=Number(j)}if(g!=null&&g!=undefined){try{if(!isNaN(g)&&g.length>0){d.height=Number(g)}else{d.height=Number(f)}}catch(l){d.height=Number(f)}}else{d.height=Number(f)}}}}}();